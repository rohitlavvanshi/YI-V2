{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Desktop/Rohit%20Workspace/Product-%20YI/supabase-saas/src/lib/supabase/admin.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\r\n\r\nexport const supabaseAdmin = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n);\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,MAAM,gBAAgB,IAAA,gMAAY,gFAEvC,QAAQ,GAAG,CAAC,yBAAyB"}},
    {"offset": {"line": 57, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Desktop/Rohit%20Workspace/Product-%20YI/supabase-saas/src/lib/llm/callLLM.ts"],"sourcesContent":["import OpenAI from 'openai';\r\n\r\nif (!process.env.OPENAI_API_KEY) {\r\n  throw new Error('OPENAI_API_KEY is missing');\r\n}\r\n\r\nconst client = new OpenAI({\r\n  apiKey: process.env.OPENAI_API_KEY,\r\n});\r\n\r\nexport async function callLLM(prompt: string): Promise<string> {\r\n  const res = await client.chat.completions.create({\r\n    model: 'gpt-4o-mini',\r\n    messages: [{ role: 'user', content: prompt }],\r\n    temperature: 0,\r\n  });\r\n\r\n  return res.choices[0].message.content || '';\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AAAA;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,cAAc,EAAE;IAC/B,MAAM,IAAI,MAAM;AAClB;AAEA,MAAM,SAAS,IAAI,mLAAM,CAAC;IACxB,QAAQ,QAAQ,GAAG,CAAC,cAAc;AACpC;AAEO,eAAe,QAAQ,MAAc;IAC1C,MAAM,MAAM,MAAM,OAAO,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;QAC/C,OAAO;QACP,UAAU;YAAC;gBAAE,MAAM;gBAAQ,SAAS;YAAO;SAAE;QAC7C,aAAa;IACf;IAEA,OAAO,IAAI,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO,IAAI;AAC3C"}},
    {"offset": {"line": 87, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Desktop/Rohit%20Workspace/Product-%20YI/supabase-saas/src/lib/prompts/loadPrompts.ts"],"sourcesContent":["export function loadPrompts() {\r\n  return {\r\n    PROMPT_BUILDER_INSTRUCTIONS: `\r\nYou are a senior market intelligence analyst.\r\nFollow instructions strictly.\r\nNever hallucinate.\r\n`,\r\n    ARTICLE_EVALUATION_INSTRUCTIONS: `\r\nFocus only on external market signals.\r\nDo not speculate.\r\n`,\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,SAAS;IACd,OAAO;QACL,6BAA6B,CAAC;;;;AAIlC,CAAC;QACG,iCAAiC,CAAC;;;AAGtC,CAAC;IACC;AACF"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Desktop/Rohit%20Workspace/Product-%20YI/supabase-saas/src/lib/prompts/schemas.ts"],"sourcesContent":["export const QUERY_GENERATION_SCHEMA = `\r\n{\r\n  \"queries\": [\r\n    \"string\",\r\n    \"string\"\r\n  ]\r\n}\r\n`;\r\n"],"names":[],"mappings":";;;;AAAO,MAAM,0BAA0B,CAAC;;;;;;;AAOxC,CAAC"}},
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Desktop/Rohit%20Workspace/Product-%20YI/supabase-saas/src/lib/llm/safeJsonParse.ts"],"sourcesContent":["export function safeJsonParse(text: string): any {\r\n  if (!text) {\r\n    throw new Error('Empty LLM response');\r\n  }\r\n\r\n  let cleaned = text.trim();\r\n\r\n  // Remove markdown fences\r\n  if (cleaned.startsWith('```')) {\r\n    cleaned = cleaned\r\n      .replace(/^```(json)?/i, '')\r\n      .replace(/```$/, '')\r\n      .trim();\r\n  }\r\n\r\n  try {\r\n    return JSON.parse(cleaned);\r\n  } catch {\r\n    // Attempt to extract JSON substring\r\n    const start = cleaned.indexOf('{');\r\n    const end = cleaned.lastIndexOf('}');\r\n\r\n    if (start !== -1 && end !== -1) {\r\n      const jsonSubstring = cleaned.slice(start, end + 1);\r\n      return JSON.parse(jsonSubstring);\r\n    }\r\n\r\n    throw new Error('Invalid JSON returned by LLM');\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,SAAS,cAAc,IAAY;IACxC,IAAI,CAAC,MAAM;QACT,MAAM,IAAI,MAAM;IAClB;IAEA,IAAI,UAAU,KAAK,IAAI;IAEvB,yBAAyB;IACzB,IAAI,QAAQ,UAAU,CAAC,QAAQ;QAC7B,UAAU,QACP,OAAO,CAAC,gBAAgB,IACxB,OAAO,CAAC,QAAQ,IAChB,IAAI;IACT;IAEA,IAAI;QACF,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAM;QACN,oCAAoC;QACpC,MAAM,QAAQ,QAAQ,OAAO,CAAC;QAC9B,MAAM,MAAM,QAAQ,WAAW,CAAC;QAEhC,IAAI,UAAU,CAAC,KAAK,QAAQ,CAAC,GAAG;YAC9B,MAAM,gBAAgB,QAAQ,KAAK,CAAC,OAAO,MAAM;YACjD,OAAO,KAAK,KAAK,CAAC;QACpB;QAEA,MAAM,IAAI,MAAM;IAClB;AACF"}},
    {"offset": {"line": 154, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Desktop/Rohit%20Workspace/Product-%20YI/supabase-saas/src/lib/research/queryGenerator.ts"],"sourcesContent":["import { callLLM } from '@/lib/llm/callLLM';\r\nimport { loadPrompts } from '@/lib/prompts/loadPrompts';\r\nimport { QUERY_GENERATION_SCHEMA } from '@/lib/prompts/schemas';\r\nimport { safeJsonParse } from '@/lib/llm/safeJsonParse';\r\n\r\nconst EXPECTED_QUERY_COUNT = 12;\r\nconst MAX_ATTEMPTS = 3;\r\n\r\n/**\r\n * Generic structural decomposition applied to ALL drivers.\r\n * This avoids driver hardcoding and guarantees query diversity.\r\n */\r\nfunction structuralDecomposition(): string {\r\n  return `\r\nYou MUST decompose the driver into DISTINCT real-world external-event categories.\r\n\r\nGenerate queries across DIFFERENT dimensions such as (examples only):\r\n- company expansion announcements\r\n- infrastructure buildouts\r\n- regulatory or government actions\r\n- capital expenditure disclosures\r\n- long-term contracts or pre-commitments\r\n- regional or geographic expansion\r\n- supply chain investments\r\n- mergers, acquisitions, or joint ventures\r\n- technology or capacity upgrades\r\n- utility, power, or energy infrastructure\r\n- public filings or earnings disclosures\r\n- industry partnerships or alliances\r\n\r\nRULES:\r\n- Each query must represent a DISTINCT real-world event\r\n- Do NOT repeat companies unless the event is materially different\r\n- Do NOT merge multiple events into one query\r\n- Do NOT generate abstract or generic statements\r\n`;\r\n}\r\n\r\nexport async function generateQueriesForDriver({\r\n  companyContext,\r\n  metric,\r\n  driver,\r\n}: {\r\n  companyContext: string;\r\n  metric: string;\r\n  driver: string;\r\n}): Promise<string[]> {\r\n  console.log(`\\n[QUERY] ‚ñ∂ Generating queries for driver: \"${driver}\"`);\r\n\r\n  const prompts = loadPrompts();\r\n  const instructions = prompts.PROMPT_BUILDER_INSTRUCTIONS;\r\n\r\n  for (let attempt = 1; attempt <= MAX_ATTEMPTS; attempt++) {\r\n    console.log(`[QUERY] Attempt ${attempt}/${MAX_ATTEMPTS}`);\r\n\r\n    const prompt = `\r\n${instructions}\r\n\r\nYou are generating SEARCH QUERIES for an AI search engine (Brave).\r\n\r\nEach query MUST describe a REAL-WORLD EXTERNAL EVENT.\r\n\r\nSTRICT RULES (NON-NEGOTIABLE):\r\n- Generate EXACTLY ${EXPECTED_QUERY_COUNT} queries\r\n- Each query must be 10‚Äì15 words\r\n- Mention REAL companies, operators, facilities, or infrastructure\r\n- Focus on EXTERNAL signals only\r\n- No placeholders\r\n- No numbering\r\n- No explanations\r\n- Queries must represent DISTINCT events\r\n\r\nCompany Context:\r\n${companyContext}\r\n\r\nTarget Metric:\r\n${metric}\r\n\r\nDriver:\r\n${driver}\r\n\r\n${structuralDecomposition()}\r\n\r\nOUTPUT FORMAT (STRICT JSON ONLY):\r\n${QUERY_GENERATION_SCHEMA}\r\n`.trim();\r\n\r\n    // 1Ô∏è‚É£ Call LLM\r\n    const raw = await callLLM(prompt);\r\n\r\n    // 2Ô∏è‚É£ Safe JSON parse (handles ```json fences)\r\n    const parsed = safeJsonParse(raw);\r\n\r\n    const queries: string[] = Array.isArray(parsed?.queries)\r\n      ? parsed.queries\r\n      : [];\r\n\r\n    // 3Ô∏è‚É£ Clean + validate\r\n    const cleaned = queries\r\n      .filter((q) => typeof q === 'string')\r\n      .map((q) => q.trim())\r\n      .filter((q) => q.split(' ').length >= 10);\r\n\r\n    console.log(\r\n      `[QUERY] Generated ${cleaned.length}/${EXPECTED_QUERY_COUNT} valid queries`\r\n    );\r\n\r\n    cleaned.forEach((q, idx) => {\r\n      console.log(`   ${idx + 1}. ${q}`);\r\n    });\r\n\r\n    if (cleaned.length === EXPECTED_QUERY_COUNT) {\r\n      console.log(\r\n        `[QUERY] ‚úÖ Query generation successful for driver \"${driver}\"`\r\n      );\r\n      return cleaned;\r\n    }\r\n\r\n    console.warn(\r\n      `‚ö†Ô∏è Query generation attempt ${attempt} failed for driver \"${driver}\". Got ${cleaned.length}/${EXPECTED_QUERY_COUNT}`\r\n    );\r\n  }\r\n\r\n  // üî¥ FINAL HARD FAIL (CORRECT BEHAVIOR)\r\n  throw new Error(\r\n    `Driver \"${driver}\" failed to generate exactly ${EXPECTED_QUERY_COUNT} queries after ${MAX_ATTEMPTS} attempts`\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,uBAAuB;AAC7B,MAAM,eAAe;AAErB;;;CAGC,GACD,SAAS;IACP,OAAO,CAAC;;;;;;;;;;;;;;;;;;;;;;AAsBV,CAAC;AACD;AAEO,eAAe,yBAAyB,EAC7C,cAAc,EACd,MAAM,EACN,MAAM,EAKP;IACC,QAAQ,GAAG,CAAC,CAAC,4CAA4C,EAAE,OAAO,CAAC,CAAC;IAEpE,MAAM,UAAU,IAAA,qJAAW;IAC3B,MAAM,eAAe,QAAQ,2BAA2B;IAExD,IAAK,IAAI,UAAU,GAAG,WAAW,cAAc,UAAW;QACxD,QAAQ,GAAG,CAAC,CAAC,gBAAgB,EAAE,QAAQ,CAAC,EAAE,cAAc;QAExD,MAAM,SAAS,CAAC;AACpB,EAAE,aAAa;;;;;;;mBAOI,EAAE,qBAAqB;;;;;;;;;;AAU1C,EAAE,eAAe;;;AAGjB,EAAE,OAAO;;;AAGT,EAAE,OAAO;;AAET,EAAE,0BAA0B;;;AAG5B,EAAE,6JAAuB,CAAC;AAC1B,CAAC,CAAC,IAAI;QAEF,eAAe;QACf,MAAM,MAAM,MAAM,IAAA,yIAAO,EAAC;QAE1B,+CAA+C;QAC/C,MAAM,SAAS,IAAA,qJAAa,EAAC;QAE7B,MAAM,UAAoB,MAAM,OAAO,CAAC,QAAQ,WAC5C,OAAO,OAAO,GACd,EAAE;QAEN,uBAAuB;QACvB,MAAM,UAAU,QACb,MAAM,CAAC,CAAC,IAAM,OAAO,MAAM,UAC3B,GAAG,CAAC,CAAC,IAAM,EAAE,IAAI,IACjB,MAAM,CAAC,CAAC,IAAM,EAAE,KAAK,CAAC,KAAK,MAAM,IAAI;QAExC,QAAQ,GAAG,CACT,CAAC,kBAAkB,EAAE,QAAQ,MAAM,CAAC,CAAC,EAAE,qBAAqB,cAAc,CAAC;QAG7E,QAAQ,OAAO,CAAC,CAAC,GAAG;YAClB,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,MAAM,EAAE,EAAE,EAAE,GAAG;QACnC;QAEA,IAAI,QAAQ,MAAM,KAAK,sBAAsB;YAC3C,QAAQ,GAAG,CACT,CAAC,kDAAkD,EAAE,OAAO,CAAC,CAAC;YAEhE,OAAO;QACT;QAEA,QAAQ,IAAI,CACV,CAAC,4BAA4B,EAAE,QAAQ,oBAAoB,EAAE,OAAO,OAAO,EAAE,QAAQ,MAAM,CAAC,CAAC,EAAE,sBAAsB;IAEzH;IAEA,wCAAwC;IACxC,MAAM,IAAI,MACR,CAAC,QAAQ,EAAE,OAAO,6BAA6B,EAAE,qBAAqB,eAAe,EAAE,aAAa,SAAS,CAAC;AAElH"}},
    {"offset": {"line": 257, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Desktop/Rohit%20Workspace/Product-%20YI/supabase-saas/src/lib/search/braveClient.ts"],"sourcesContent":["export async function searchBrave(\r\n  query: string,\r\n  days: number\r\n) {\r\n  const apiKey = process.env.BRAVE_API_KEY;\r\n  if (!apiKey) throw new Error('BRAVE_API_KEY missing');\r\n\r\n  const params = new URLSearchParams({\r\n    q: query,\r\n    recency: days.toString(),\r\n  });\r\n\r\n  const res = await fetch(\r\n    `https://api.search.brave.com/res/v1/news/search?${params}`,\r\n    {\r\n      headers: {\r\n        'X-Subscription-Token': apiKey,\r\n        Accept: 'application/json',\r\n      },\r\n    }\r\n  );\r\n\r\n  const json = await res.json();\r\n  return json?.results || [];\r\n}\r\n"],"names":[],"mappings":";;;;AAAO,eAAe,YACpB,KAAa,EACb,IAAY;IAEZ,MAAM,SAAS,QAAQ,GAAG,CAAC,aAAa;IACxC,IAAI,CAAC,QAAQ,MAAM,IAAI,MAAM;IAE7B,MAAM,SAAS,IAAI,gBAAgB;QACjC,GAAG;QACH,SAAS,KAAK,QAAQ;IACxB;IAEA,MAAM,MAAM,MAAM,MAChB,CAAC,gDAAgD,EAAE,QAAQ,EAC3D;QACE,SAAS;YACP,wBAAwB;YACxB,QAAQ;QACV;IACF;IAGF,MAAM,OAAO,MAAM,IAAI,IAAI;IAC3B,OAAO,MAAM,WAAW,EAAE;AAC5B"}},
    {"offset": {"line": 281, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Desktop/Rohit%20Workspace/Product-%20YI/supabase-saas/src/lib/search/searchExecutor.ts"],"sourcesContent":["import { searchBrave } from '@/lib/search/braveClient';\r\n\r\n/**\r\n * Normalized Brave article shape\r\n */\r\ntype SearchArticle = {\r\n  title: string;\r\n  url: string;\r\n  description?: string;\r\n  source?: string;\r\n  published_date?: string;\r\n};\r\n\r\n/**\r\n * Executes Brave search for each query of each driver\r\n * and returns results grouped by driver ‚Üí query ‚Üí articles\r\n */\r\nexport async function runSearch(\r\n  queriesByDriver: Record<string, string[]>,\r\n  days: number\r\n): Promise<Record<string, Record<string, SearchArticle[]>>> {\r\n  console.log(`\\n[SEARCH] üîç Starting Brave search (recency: ${days} days)`);\r\n\r\n  const allResults: Record<\r\n    string,\r\n    Record<string, SearchArticle[]>\r\n  > = {};\r\n\r\n  for (const [driver, queries] of Object.entries(queriesByDriver)) {\r\n    console.log(`\\n[SEARCH] ‚ñ∂ Driver: \"${driver}\"`);\r\n\r\n    // üîí Hard enforcement (should never fail if generator works)\r\n    if (queries.length !== 12) {\r\n      throw new Error(\r\n        `Driver \"${driver}\" must have exactly 12 queries (got ${queries.length})`\r\n      );\r\n    }\r\n\r\n    const driverResults: Record<string, SearchArticle[]> = {};\r\n\r\n    for (const query of queries) {\r\n      console.log(`[SEARCH] ‚Üí Query: ${query}`);\r\n\r\n      try {\r\n        const results = await searchBrave(query, days);\r\n\r\n        console.log(\r\n          `[SEARCH] ‚Üê ${results.length} articles returned`\r\n        );\r\n\r\n        driverResults[query] = results;\r\n      } catch (err) {\r\n        console.error(\r\n          `[SEARCH] ‚ùå Brave search failed for query: \"${query}\"`,\r\n          err\r\n        );\r\n\r\n        // Fail fast ‚Äî bad search means unreliable research\r\n        throw err;\r\n      }\r\n    }\r\n\r\n    allResults[driver] = driverResults;\r\n  }\r\n\r\n  console.log(`[SEARCH] ‚úÖ Brave search completed`);\r\n  return allResults;\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAiBO,eAAe,UACpB,eAAyC,EACzC,IAAY;IAEZ,QAAQ,GAAG,CAAC,CAAC,8CAA8C,EAAE,KAAK,MAAM,CAAC;IAEzE,MAAM,aAGF,CAAC;IAEL,KAAK,MAAM,CAAC,QAAQ,QAAQ,IAAI,OAAO,OAAO,CAAC,iBAAkB;QAC/D,QAAQ,GAAG,CAAC,CAAC,sBAAsB,EAAE,OAAO,CAAC,CAAC;QAE9C,6DAA6D;QAC7D,IAAI,QAAQ,MAAM,KAAK,IAAI;YACzB,MAAM,IAAI,MACR,CAAC,QAAQ,EAAE,OAAO,oCAAoC,EAAE,QAAQ,MAAM,CAAC,CAAC,CAAC;QAE7E;QAEA,MAAM,gBAAiD,CAAC;QAExD,KAAK,MAAM,SAAS,QAAS;YAC3B,QAAQ,GAAG,CAAC,CAAC,kBAAkB,EAAE,OAAO;YAExC,IAAI;gBACF,MAAM,UAAU,MAAM,IAAA,oJAAW,EAAC,OAAO;gBAEzC,QAAQ,GAAG,CACT,CAAC,WAAW,EAAE,QAAQ,MAAM,CAAC,kBAAkB,CAAC;gBAGlD,aAAa,CAAC,MAAM,GAAG;YACzB,EAAE,OAAO,KAAK;gBACZ,QAAQ,KAAK,CACX,CAAC,2CAA2C,EAAE,MAAM,CAAC,CAAC,EACtD;gBAGF,mDAAmD;gBACnD,MAAM;YACR;QACF;QAEA,UAAU,CAAC,OAAO,GAAG;IACvB;IAEA,QAAQ,GAAG,CAAC,CAAC,iCAAiC,CAAC;IAC/C,OAAO;AACT"}},
    {"offset": {"line": 318, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Desktop/Rohit%20Workspace/Product-%20YI/supabase-saas/src/lib/research/evaluateArticle.ts"],"sourcesContent":["import { callLLM } from '@/lib/llm/callLLM';\r\nimport { safeJsonParse } from '@/lib/llm/safeJsonParse';\r\nimport { loadPrompts } from '@/lib/prompts/loadPrompts';\r\n\r\nconst MAX_ARTICLE_CHARS = 8000;\r\nconst MIN_ARTICLE_CHARS = 500;\r\n\r\nexport async function evaluateArticle({\r\n  article,\r\n  context,\r\n  metric,\r\n  driver,\r\n}: {\r\n  article: string;\r\n  context: string;\r\n  metric: string;\r\n  driver: string;\r\n}) {\r\n  // üö´ Skip junk articles\r\n  if (!article || article.length < MIN_ARTICLE_CHARS) {\r\n    return {\r\n      score: 1,\r\n      summary:\r\n        'Article content unavailable or insufficient for reliable evaluation.',\r\n    };\r\n  }\r\n\r\n  const prompts = loadPrompts();\r\n  const userInstruction =\r\n    prompts.ARTICLE_EVALUATION_INSTRUCTIONS || '';\r\n\r\n  const systemPrompt = `\r\nYou are an expert equity research and market intelligence analyst.\r\n\r\nYou must evaluate the article strictly as an EXTERNAL SIGNAL.\r\n\r\nContext:\r\n${context}\r\n\r\nTarget Metric:\r\n${metric}\r\n\r\nDriver:\r\n${driver}\r\n\r\nArticle Content:\r\n\"\"\"\r\n${article.slice(0, MAX_ARTICLE_CHARS)}\r\n\"\"\"\r\n\r\nEvaluation Rules:\r\n- Assign a relevance score from 1 to 5\r\n- Score reflects how strongly the article indicates movement in the metric via the driver\r\n- Generate a concise executive summary (max 3 sentences)\r\n- Do NOT speculate or add external knowledge\r\n- Base judgment ONLY on the article\r\n\r\nUser Guidance:\r\n${userInstruction}\r\n\r\nOUTPUT FORMAT (STRICT JSON ONLY):\r\n{\r\n  \"score\": <integer 1-5>,\r\n  \"summary\": \"<short summary>\"\r\n}\r\n`.trim();\r\n\r\n  try {\r\n    const raw = await callLLM(systemPrompt);\r\n    const parsed = safeJsonParse(raw);\r\n\r\n    const score = Math.min(\r\n      Math.max(Number(parsed.score) || 1, 1),\r\n      5\r\n    );\r\n\r\n    const summary =\r\n      typeof parsed.summary === 'string' && parsed.summary.trim()\r\n        ? parsed.summary.trim()\r\n        : 'No summary returned.';\r\n\r\n    return { score, summary };\r\n  } catch (err) {\r\n    console.error('Article evaluation failed:', err);\r\n\r\n    // ‚úÖ Never crash pipeline\r\n    return {\r\n      score: 1,\r\n      summary: 'Article could not be reliably evaluated.',\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,MAAM,oBAAoB;AAC1B,MAAM,oBAAoB;AAEnB,eAAe,gBAAgB,EACpC,OAAO,EACP,OAAO,EACP,MAAM,EACN,MAAM,EAMP;IACC,wBAAwB;IACxB,IAAI,CAAC,WAAW,QAAQ,MAAM,GAAG,mBAAmB;QAClD,OAAO;YACL,OAAO;YACP,SACE;QACJ;IACF;IAEA,MAAM,UAAU,IAAA,qJAAW;IAC3B,MAAM,kBACJ,QAAQ,+BAA+B,IAAI;IAE7C,MAAM,eAAe,CAAC;;;;;;AAMxB,EAAE,QAAQ;;;AAGV,EAAE,OAAO;;;AAGT,EAAE,OAAO;;;;AAIT,EAAE,QAAQ,KAAK,CAAC,GAAG,mBAAmB;;;;;;;;;;;AAWtC,EAAE,gBAAgB;;;;;;;AAOlB,CAAC,CAAC,IAAI;IAEJ,IAAI;QACF,MAAM,MAAM,MAAM,IAAA,yIAAO,EAAC;QAC1B,MAAM,SAAS,IAAA,qJAAa,EAAC;QAE7B,MAAM,QAAQ,KAAK,GAAG,CACpB,KAAK,GAAG,CAAC,OAAO,OAAO,KAAK,KAAK,GAAG,IACpC;QAGF,MAAM,UACJ,OAAO,OAAO,OAAO,KAAK,YAAY,OAAO,OAAO,CAAC,IAAI,KACrD,OAAO,OAAO,CAAC,IAAI,KACnB;QAEN,OAAO;YAAE;YAAO;QAAQ;IAC1B,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,8BAA8B;QAE5C,yBAAyB;QACzB,OAAO;YACL,OAAO;YACP,SAAS;QACX;IACF;AACF"}},
    {"offset": {"line": 397, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Desktop/Rohit%20Workspace/Product-%20YI/supabase-saas/src/lib/research/processArticles.ts"],"sourcesContent":["import { supabaseAdmin } from '@/lib/supabase/admin';\r\nimport { evaluateArticle } from './evaluateArticle';\r\n\r\ntype SearchArticle = {\r\n  title: string;\r\n  url: string;\r\n  description?: string;\r\n};\r\n\r\ntype SearchResultsByDriver = Record<\r\n  number,\r\n  Record<string, SearchArticle[]>\r\n>;\r\n\r\nexport async function processAndStoreArticles({\r\n  companyId,\r\n  context,\r\n  metric,\r\n  searchResults,\r\n}: {\r\n  companyId: number;\r\n  context: string;\r\n  metric: string;\r\n  searchResults: SearchResultsByDriver;\r\n}) {\r\n  console.log(\r\n    `\\n[PROCESS] üß† Starting article processing for company ${companyId}`\r\n  );\r\n\r\n  let totalArticles = 0;\r\n  let evaluatedArticles = 0;\r\n  let savedArticles = 0;\r\n  let skippedArticles = 0;\r\n\r\n  /* --------------------------------------------------\r\n     Loop per DRIVER (driverId is numeric by design)\r\n  -------------------------------------------------- */\r\n  for (const [driverIdStr, queriesByQuery] of Object.entries(\r\n    searchResults\r\n  )) {\r\n    const driverId = Number(driverIdStr);\r\n\r\n    console.log(\r\n      `\\n[PROCESS] ‚ñ∂ Driver ID: ${driverId}`\r\n    );\r\n\r\n    /* --------------------------------------------------\r\n       Loop per QUERY\r\n    -------------------------------------------------- */\r\n    for (const [query, articles] of Object.entries(\r\n      queriesByQuery\r\n    )) {\r\n      console.log(\r\n        `[PROCESS] Query ‚Üí ${articles.length} articles`\r\n      );\r\n\r\n      /* --------------------------------------------------\r\n         Loop per ARTICLE\r\n      -------------------------------------------------- */\r\n      for (const article of articles) {\r\n        totalArticles++;\r\n\r\n        const rawContent = article.description?.trim() || '';\r\n\r\n        // üö´ Skip weak / empty content\r\n        if (!rawContent) {\r\n          skippedArticles++;\r\n          console.log(\r\n            `[SKIP] ‚ùå Empty content ‚Üí \"${article.title}\"`\r\n          );\r\n          continue;\r\n        }\r\n\r\n        evaluatedArticles++;\r\n\r\n        /* ----------------------------------------------\r\n           Evaluate article via OpenAI\r\n        ---------------------------------------------- */\r\n        const evaluation = await evaluateArticle({\r\n          article: rawContent,\r\n          context,\r\n          metric,\r\n          driver: String(driverId), // driver context only\r\n        });\r\n\r\n        console.log(\r\n          `[EVALUATION] \"${article.title}\" ‚Üí score=${evaluation.score}`\r\n        );\r\n\r\n        // üö´ Save ONLY strong signals\r\n        if (evaluation.score < 4) {\r\n          skippedArticles++;\r\n          console.log(\r\n            `[SKIP] ‚õî Score too low (${evaluation.score})`\r\n          );\r\n          continue;\r\n        }\r\n\r\n        /* ----------------------------------------------\r\n           Persist to database\r\n        ---------------------------------------------- */\r\n        const { error } = await supabaseAdmin\r\n          .from('articles')\r\n          .insert({\r\n            company_id: companyId,\r\n            title: article.title,\r\n            url: article.url,\r\n            snippet: article.description || '',\r\n            article_content: rawContent,\r\n            summary: evaluation.summary,\r\n            score: evaluation.score,\r\n            driver: driverId, // ‚úÖ bigint-safe\r\n          });\r\n\r\n        if (error) {\r\n          console.error(\r\n            `[DB] ‚ùå Failed to save article \"${article.title}\"`,\r\n            error\r\n          );\r\n          continue;\r\n        }\r\n\r\n        savedArticles++;\r\n        console.log(\r\n          `[DB] ‚úÖ Saved article: \"${article.title}\"`\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  console.log(`\\n[PROCESS] ‚úÖ Processing completed`);\r\n  console.log(\r\n    `[PROCESS] Total: ${totalArticles}, Evaluated: ${evaluatedArticles}, Saved: ${savedArticles}, Skipped: ${skippedArticles}`\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAaO,eAAe,wBAAwB,EAC5C,SAAS,EACT,OAAO,EACP,MAAM,EACN,aAAa,EAMd;IACC,QAAQ,GAAG,CACT,CAAC,uDAAuD,EAAE,WAAW;IAGvE,IAAI,gBAAgB;IACpB,IAAI,oBAAoB;IACxB,IAAI,gBAAgB;IACpB,IAAI,kBAAkB;IAEtB;;qDAEmD,GACnD,KAAK,MAAM,CAAC,aAAa,eAAe,IAAI,OAAO,OAAO,CACxD,eACC;QACD,MAAM,WAAW,OAAO;QAExB,QAAQ,GAAG,CACT,CAAC,yBAAyB,EAAE,UAAU;QAGxC;;uDAEmD,GACnD,KAAK,MAAM,CAAC,OAAO,SAAS,IAAI,OAAO,OAAO,CAC5C,gBACC;YACD,QAAQ,GAAG,CACT,CAAC,kBAAkB,EAAE,SAAS,MAAM,CAAC,SAAS,CAAC;YAGjD;;yDAEmD,GACnD,KAAK,MAAM,WAAW,SAAU;gBAC9B;gBAEA,MAAM,aAAa,QAAQ,WAAW,EAAE,UAAU;gBAElD,+BAA+B;gBAC/B,IAAI,CAAC,YAAY;oBACf;oBACA,QAAQ,GAAG,CACT,CAAC,0BAA0B,EAAE,QAAQ,KAAK,CAAC,CAAC,CAAC;oBAE/C;gBACF;gBAEA;gBAEA;;uDAE+C,GAC/C,MAAM,aAAa,MAAM,IAAA,8JAAe,EAAC;oBACvC,SAAS;oBACT;oBACA;oBACA,QAAQ,OAAO;gBACjB;gBAEA,QAAQ,GAAG,CACT,CAAC,cAAc,EAAE,QAAQ,KAAK,CAAC,UAAU,EAAE,WAAW,KAAK,EAAE;gBAG/D,8BAA8B;gBAC9B,IAAI,WAAW,KAAK,GAAG,GAAG;oBACxB;oBACA,QAAQ,GAAG,CACT,CAAC,wBAAwB,EAAE,WAAW,KAAK,CAAC,CAAC,CAAC;oBAEhD;gBACF;gBAEA;;uDAE+C,GAC/C,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,kJAAa,CAClC,IAAI,CAAC,YACL,MAAM,CAAC;oBACN,YAAY;oBACZ,OAAO,QAAQ,KAAK;oBACpB,KAAK,QAAQ,GAAG;oBAChB,SAAS,QAAQ,WAAW,IAAI;oBAChC,iBAAiB;oBACjB,SAAS,WAAW,OAAO;oBAC3B,OAAO,WAAW,KAAK;oBACvB,QAAQ;gBACV;gBAEF,IAAI,OAAO;oBACT,QAAQ,KAAK,CACX,CAAC,+BAA+B,EAAE,QAAQ,KAAK,CAAC,CAAC,CAAC,EAClD;oBAEF;gBACF;gBAEA;gBACA,QAAQ,GAAG,CACT,CAAC,uBAAuB,EAAE,QAAQ,KAAK,CAAC,CAAC,CAAC;YAE9C;QACF;IACF;IAEA,QAAQ,GAAG,CAAC,CAAC,kCAAkC,CAAC;IAChD,QAAQ,GAAG,CACT,CAAC,iBAAiB,EAAE,cAAc,aAAa,EAAE,kBAAkB,SAAS,EAAE,cAAc,WAAW,EAAE,iBAAiB;AAE9H"}},
    {"offset": {"line": 475, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Desktop/Rohit%20Workspace/Product-%20YI/supabase-saas/src/lib/research/startCompanyResearch.ts"],"sourcesContent":["import { generateQueriesForDriver } from './queryGenerator';\r\nimport { runSearch } from '@/lib/search/searchExecutor';\r\nimport { processAndStoreArticles } from './processArticles';\r\n\r\n/**\r\n * Driver object MUST contain both:\r\n * - id   ‚Üí used for DB storage (bigint)\r\n * - name ‚Üí used for LLM + search\r\n */\r\ntype DriverInput = {\r\n  id: number;\r\n  name: string;\r\n};\r\n\r\nexport async function startCompanyResearch({\r\n  companyId,\r\n  companyContext,\r\n  drivers,\r\n  metric,\r\n}: {\r\n  companyId: number;\r\n  companyContext: string;\r\n  drivers: DriverInput[];\r\n  metric: string;\r\n}) {\r\n  console.log(\r\n    `\\n[RESEARCH] üöÄ Starting research for company ${companyId}`\r\n  );\r\n\r\n  if (!drivers || drivers.length === 0) {\r\n    throw new Error('[RESEARCH] No drivers provided');\r\n  }\r\n\r\n  /**\r\n   * driverId ‚Üí queries[]\r\n   * (ID is the ONLY thing that flows into DB)\r\n   */\r\n  const queriesByDriver: Record<number, string[]> = {};\r\n\r\n  /* --------------------------------------------------\r\n     1Ô∏è‚É£ Generate queries per driver\r\n  -------------------------------------------------- */\r\n  console.log(`[RESEARCH] üß© Generating queries`);\r\n\r\n  for (const driver of drivers) {\r\n    console.log(\r\n      `\\n[QUERY] ‚ñ∂ Generating queries for driver: \"${driver.name}\" (id=${driver.id})`\r\n    );\r\n\r\n    const queries = await generateQueriesForDriver({\r\n      companyContext,\r\n      metric,\r\n      driver: driver.name, // üëà NAME ONLY for LLM\r\n    });\r\n\r\n    console.log(\r\n      `[QUERY] ‚úÖ Generated ${queries.length}/12 valid queries`\r\n    );\r\n\r\n    queriesByDriver[driver.id] = queries;\r\n  }\r\n\r\n  /* --------------------------------------------------\r\n     2Ô∏è‚É£ Execute Brave search\r\n  -------------------------------------------------- */\r\n  console.log(`\\n[RESEARCH] üîç Executing Brave search`);\r\n\r\n  const searchResults = await runSearch(\r\n    queriesByDriver,\r\n    30 // days\r\n  );\r\n\r\n  console.log(`[RESEARCH] ‚úÖ Brave search completed`);\r\n\r\n  /* --------------------------------------------------\r\n     3Ô∏è‚É£ Evaluate + store articles\r\n  -------------------------------------------------- */\r\n  console.log(`\\n[RESEARCH] üß† Evaluating and storing articles`);\r\n\r\n  await processAndStoreArticles({\r\n    companyId,\r\n    context: companyContext,\r\n    metric,\r\n    searchResults,\r\n  });\r\n\r\n  console.log(\r\n    `\\n[RESEARCH] üéâ Research completed successfully for company ${companyId}`\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAYO,eAAe,qBAAqB,EACzC,SAAS,EACT,cAAc,EACd,OAAO,EACP,MAAM,EAMP;IACC,QAAQ,GAAG,CACT,CAAC,8CAA8C,EAAE,WAAW;IAG9D,IAAI,CAAC,WAAW,QAAQ,MAAM,KAAK,GAAG;QACpC,MAAM,IAAI,MAAM;IAClB;IAEA;;;GAGC,GACD,MAAM,kBAA4C,CAAC;IAEnD;;qDAEmD,GACnD,QAAQ,GAAG,CAAC,CAAC,gCAAgC,CAAC;IAE9C,KAAK,MAAM,UAAU,QAAS;QAC5B,QAAQ,GAAG,CACT,CAAC,4CAA4C,EAAE,OAAO,IAAI,CAAC,MAAM,EAAE,OAAO,EAAE,CAAC,CAAC,CAAC;QAGjF,MAAM,UAAU,MAAM,IAAA,sKAAwB,EAAC;YAC7C;YACA;YACA,QAAQ,OAAO,IAAI;QACrB;QAEA,QAAQ,GAAG,CACT,CAAC,oBAAoB,EAAE,QAAQ,MAAM,CAAC,iBAAiB,CAAC;QAG1D,eAAe,CAAC,OAAO,EAAE,CAAC,GAAG;IAC/B;IAEA;;qDAEmD,GACnD,QAAQ,GAAG,CAAC,CAAC,sCAAsC,CAAC;IAEpD,MAAM,gBAAgB,MAAM,IAAA,qJAAS,EACnC,iBACA,GAAG,OAAO;;IAGZ,QAAQ,GAAG,CAAC,CAAC,mCAAmC,CAAC;IAEjD;;qDAEmD,GACnD,QAAQ,GAAG,CAAC,CAAC,+CAA+C,CAAC;IAE7D,MAAM,IAAA,sKAAuB,EAAC;QAC5B;QACA,SAAS;QACT;QACA;IACF;IAEA,QAAQ,GAAG,CACT,CAAC,4DAA4D,EAAE,WAAW;AAE9E"}},
    {"offset": {"line": 528, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Desktop/Rohit%20Workspace/Product-%20YI/supabase-saas/src/app/api/manager/companies/%5Bid%5D/start-research/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { supabaseAdmin } from '@/lib/supabase/admin';\r\nimport { startCompanyResearch } from '@/lib/research/startCompanyResearch';\r\n\r\nexport async function POST(\r\n  _req: Request,\r\n  context: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const { id } = await context.params;\r\n    const companyId = Number(id);\r\n\r\n    if (!companyId) {\r\n      return NextResponse.json(\r\n        { error: 'Invalid company ID' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    /* --------------------------------------------------\r\n       1Ô∏è‚É£ Fetch company context\r\n    -------------------------------------------------- */\r\n    const { data: company, error: companyError } =\r\n      await supabaseAdmin\r\n        .from('companies')\r\n        .select('company_context')\r\n        .eq('id', companyId)\r\n        .single();\r\n\r\n    if (companyError || !company) {\r\n      return NextResponse.json(\r\n        { error: 'Company not found' },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (!company.company_context) {\r\n      return NextResponse.json(\r\n        { error: 'Company context is missing' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    /* --------------------------------------------------\r\n       2Ô∏è‚É£ Fetch drivers (ID + NAME)\r\n    -------------------------------------------------- */\r\n    const { data: drivers, error: driversError } =\r\n      await supabaseAdmin\r\n        .from('drivers')\r\n        .select('id, driver')\r\n        .eq('company_id', companyId);\r\n\r\n    if (driversError || !drivers || drivers.length === 0) {\r\n      return NextResponse.json(\r\n        { error: 'No drivers found for company' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    /* --------------------------------------------------\r\n       3Ô∏è‚É£ Start research (CORRECT SHAPE)\r\n    -------------------------------------------------- */\r\n    await startCompanyResearch({\r\n      companyId,\r\n      companyContext: company.company_context,\r\n      metric: 'Revenue Growth',\r\n      drivers: drivers.map((d) => ({\r\n        id: d.id,\r\n        name: d.driver,\r\n      })),\r\n    });\r\n\r\n    return NextResponse.json({ success: true });\r\n  } catch (err: any) {\r\n    console.error('Start research failed:', err);\r\n\r\n    return NextResponse.json(\r\n      { error: err.message || 'Failed to start research' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,eAAe,KACpB,IAAa,EACb,OAA4C;IAE5C,IAAI;QACF,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM,QAAQ,MAAM;QACnC,MAAM,YAAY,OAAO;QAEzB,IAAI,CAAC,WAAW;YACd,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAqB,GAC9B;gBAAE,QAAQ;YAAI;QAElB;QAEA;;uDAEmD,GACnD,MAAM,EAAE,MAAM,OAAO,EAAE,OAAO,YAAY,EAAE,GAC1C,MAAM,kJAAa,CAChB,IAAI,CAAC,aACL,MAAM,CAAC,mBACP,EAAE,CAAC,MAAM,WACT,MAAM;QAEX,IAAI,gBAAgB,CAAC,SAAS;YAC5B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAoB,GAC7B;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,CAAC,QAAQ,eAAe,EAAE;YAC5B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA6B,GACtC;gBAAE,QAAQ;YAAI;QAElB;QAEA;;uDAEmD,GACnD,MAAM,EAAE,MAAM,OAAO,EAAE,OAAO,YAAY,EAAE,GAC1C,MAAM,kJAAa,CAChB,IAAI,CAAC,WACL,MAAM,CAAC,cACP,EAAE,CAAC,cAAc;QAEtB,IAAI,gBAAgB,CAAC,WAAW,QAAQ,MAAM,KAAK,GAAG;YACpD,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA+B,GACxC;gBAAE,QAAQ;YAAI;QAElB;QAEA;;uDAEmD,GACnD,MAAM,IAAA,wKAAoB,EAAC;YACzB;YACA,gBAAgB,QAAQ,eAAe;YACvC,QAAQ;YACR,SAAS,QAAQ,GAAG,CAAC,CAAC,IAAM,CAAC;oBAC3B,IAAI,EAAE,EAAE;oBACR,MAAM,EAAE,MAAM;gBAChB,CAAC;QACH;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3C,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,0BAA0B;QAExC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,IAAI,OAAO,IAAI;QAA2B,GACnD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}